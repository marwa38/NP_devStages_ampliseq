
```{r}
library(Rcpp)
library(dada2)
library(phyloseq)
library(permute)
library(lattice)
library(vegan)
library(ggplot2)
library(tidyverse)
library(ggstatsplot)
library(dplyr)
library(microbiome)
library(microbiomeutilities) 
library(knitr)
library(RColorBrewer)
library(DT)
library(gt)
library(cowplot)
library(PerformanceAnalytics)


```


```{r}
ps.prev <- readRDS("phyobjects/STEP 14/ps.prev.f.rds")

ps_tss_1 <- transform_sample_counts(ps.prev, function(x){x / sum(x)})
mtd <- data.frame(sample_data(ps.prev), check.names = FALSE)
```


```{r}
# compute OTU prevalence
prvl <- list()
for (i in c("M", "V", "MM", "VM", "MMV", "VMV", 
            "water.M", "water.V", "water.MM", "water.VM", "water.MMV", "water.VMV")) {
    prvl[[i]] <- subset_samples(ps_tss_1, sample.name.1 == i) %>%
      prevalence(detection = 0.0005, count = TRUE, include.lowest = TRUE)
}
for (i in c("feed.M", "feed.V")) {
    prvl[[i]] <- subset_samples(ps_tss_1, sample.name.1 == i) %>%
      prevalence(detection = 0.0005, count = TRUE, include.lowest = TRUE)
}
```


Compute ASV overlap

```{r}
ovrl <- bind_cols(prvl) %>%
  pivot_longer(M:VMV, 
               names_to = "SAMPLE", 
               values_to = "Intestine") %>%
  # compute OTU overlap between water/feed and intestinal samples
  mutate(
    WaterOverlapM = case_when(
      water.M > 0 & Intestine >  0 ~ "Shared",
      water.M > 0 & Intestine == 0 ~ "Unique to water",
      water.M == 0 & Intestine >  0 ~ "Unique to intestine",
      TRUE ~ "Absent"),
    WaterOverlapV = case_when(
      water.V > 0 & Intestine >  0 ~ "Shared",
      water.V > 0 & Intestine == 0 ~ "Unique to water",
      water.V == 0 & Intestine >  0 ~ "Unique to intestine",
      TRUE ~ "Absent"),
    WaterOverlapMM = case_when(
      water.MM > 0 & Intestine >  0 ~ "Shared",
      water.MM > 0 & Intestine == 0 ~ "Unique to water",
      water.MM == 0 & Intestine >  0 ~ "Unique to intestine",
      TRUE ~ "Absent"),
    WaterOverlapVM = case_when(
      water.VM > 0 & Intestine >  0 ~ "Shared",
      water.VM > 0 & Intestine == 0 ~ "Unique to water",
      water.VM == 0 & Intestine >  0 ~ "Unique to intestine",
      TRUE ~ "Absent"),
    WaterOverlapMMV = case_when(
      water.MMV > 0 & Intestine >  0 ~ "Shared",
      water.MMV > 0 & Intestine == 0 ~ "Unique to water",
      water.MMV == 0 & Intestine >  0 ~ "Unique to intestine",
      TRUE ~ "Absent"),
    WaterOverlapVMV = case_when(
      water.VMV > 0 & Intestine >  0 ~ "Shared",
      water.VMV > 0 & Intestine == 0 ~ "Unique to water",
      water.VMV == 0 & Intestine >  0 ~ "Unique to intestine",
      TRUE ~ "Absent"),
    FeedOverlapM = case_when(
      feed.M > 0 & Intestine >  0 ~ "Shared",
      feed.M > 0 & Intestine == 0 ~ "Unique to feed",
      feed.M == 0 & Intestine >  0 ~ "Unique to intestine",
      TRUE ~ "Absent"),
    FeedOverlapV = case_when(
      feed.V > 0 & Intestine >  0 ~ "Shared",
      feed.V > 0 & Intestine == 0 ~ "Unique to feed",
      feed.V == 0 & Intestine >  0 ~ "Unique to intestine",
      TRUE ~ "Absent"),
    FeedOverlapMM = case_when(
      feed.M > 0 & Intestine >  0 ~ "Shared",
      feed.M > 0 & Intestine == 0 ~ "Unique to feed",
      feed.M == 0 & Intestine >  0 ~ "Unique to intestine",
      TRUE ~ "Absent"),
    FeedOverlapVM = case_when(
      feed.M > 0 & Intestine >  0 ~ "Shared",
      feed.M > 0 & Intestine == 0 ~ "Unique to feed",
      feed.M == 0 & Intestine >  0 ~ "Unique to intestine",
      TRUE ~ "Absent"),
    FeedOverlapMMV = case_when(
      feed.V > 0 & Intestine >  0 ~ "Shared",
      feed.V > 0 & Intestine == 0 ~ "Unique to feed",
      feed.V == 0 & Intestine >  0 ~ "Unique to intestine",
      TRUE ~ "Absent"),
    FeedOverlapVMV = case_when(
      feed.V > 0 & Intestine >  0 ~ "Shared",
      feed.V > 0 & Intestine == 0 ~ "Unique to feed",
      feed.V == 0 & Intestine >  0 ~ "Unique to intestine",
      TRUE ~ "Absent")) %>%
  pivot_longer(WaterOverlapM:FeedOverlapVMV, 
               names_to = "OverlapType", 
               values_to = "Category") %>%
  count(OverlapType, SAMPLE, Category) %>%
  mutate(
    Category = factor(
      Category, 
      levels = c("Unique to water", "Unique to feed", 
                 "Shared", "Unique to intestine", "Absent")),
    #Diet = ifelse(grepl("FM", Sample), "FM", "ICJ", "ACJ", "IWA", "AWA", "SBM"),
    Sample_Regime = factor(SAMPLE, levels = c("M", "V", "MM", "VM", "MMV", "VMV")))

```

Plotting
Plot microbial overlap between feed and intestinal samples.

```{r}
ovrl_bar_feed <- ovrl %>%
  filter(OverlapType == "FeedOverlapM" & Sample_Regime == "M" |
         OverlapType == "FeedOverlapV"  & Sample_Regime == "V" | 
         OverlapType == "FeedOverlapMM"  & Sample_Regime == "MM"| 
         OverlapType == "FeedOverlapVM"  & Sample_Regime == "VM" | 
         OverlapType == "FeedOverlapMMV"  & Sample_Regime == "MMV"| 
         OverlapType == "FeedOverlapVMV"  & Sample_Regime == "VMV") %>%
  filter(Category != "Absent") %>%
  ggplot(aes(x = SAMPLE, c("M", "V", "MM", "VM", "MMV", "VMV"), 
             y = n, fill = Category, label = n)) +
  geom_bar(stat = "identity") +
  geom_text(position = position_stack(vjust = 0.5), color = "white", size = 2.5) +
  labs(x = "", y = "Number of ASVs", size = 10) +
  scale_y_continuous(expand = expansion(mult = c(0, 0.1))) + 
  scale_fill_manual(values = c("#B2DF8A", "grey50", "#33A02C")) +
  #facet_nested(~ Diet + Site, scales = "free_x", nest_line = TRUE) +
  scale_x_discrete(limit=c("M", "V", "MM", "VM", "MMV", "VMV")) +
  theme_bw() +
  theme(axis.text.x = element_text (size = 9),
        strip.background = element_blank(),
        legend.title = element_blank(),
        legend.margin = margin(0, 0, 0, 0),
        legend.box.margin = margin(0, 0, 0, -5))  

```


Plot microbial overlap between water and intestinal samples.

```{r}
ovrl_bar_water <- ovrl %>%
  filter(OverlapType == "WaterOverlapM" & Sample_Regime == "M" |
         OverlapType == "WaterOverlapV"  & Sample_Regime == "V" |
         OverlapType == "WaterOverlapMM"  & Sample_Regime == "MM"|
         OverlapType == "WaterOverlapVM"  & Sample_Regime == "VM" |
         OverlapType == "WaterOverlapMMV"  & Sample_Regime == "MMV"|
         OverlapType == "WaterOverlapVMV"  & Sample_Regime == "VMV") %>%
  filter(Category != "Absent") %>%
  ggplot(aes(x = SAMPLE, c("M", "V", "MM", "VM", "MMV", "VMV"), 
             y = n, fill = Category, label = n)) +
  geom_bar(stat = "identity") +
  geom_text(position = position_stack(vjust = 0.5), color = "white", size = 2.5) +
  labs(x = "", y = "Number of ASVs", size = 10) +
  scale_y_continuous(expand = expansion(mult = c(0, 0.1))) + 
  scale_fill_manual(values = c("#A6CEE3", "grey50", "#1F78B4")) +
  #facet_nested(~ Diet + Site, scales = "free_x", nest_line = TRUE) +
  scale_x_discrete(limit=c("M", "V", "MM", "VM", "MMV", "VMV")) +
  theme_bw() +
  theme(axis.text.x = element_text (size = 9),
        strip.background = element_blank(),
        legend.title = element_blank(),
        legend.margin = margin(0, 0, 0, 0),
        legend.box.margin = margin(0, 0, 0, -5))  
```

Assemble plots

```{r}
ovrl_bar_feed + ovrl_bar_water  
```

Abundance of ASVs shared

Compute shared ASV abundance

Compute the abundance of shared ASVs between feed and intestinal samples.


```{r}
shared_feed <- map(c("feed.M", "feed.V", "feed.M", "feed.M", "feed.V", "feed.V"), function(x) {
  prune_taxa(names(which(prvl[[x]] > 0)), ps_tss_1) %>% sample_sums()
  }
)
names(shared_feed) <- c("M", "V", "MM", "VM", "MMV", "VMV")
# names(prvl)

shared_feed <- map(seq_along(shared_feed), function(x){
  data.frame(Abundance = shared_feed[[x]]) %>%
  rownames_to_column("sample_name") %>%
  inner_join(rownames_to_column(mtd, "sample_name"), by = "sample_name") %>%
  filter(Regime == names(shared_feed)[x] & !sample %in% c("feed", "water")) %>%
  #mutate(Segment = ifelse(Segment == "PI", "PIM", "DIM"),
         #Segment = factor(Segment, levels = c("PIM", "DIM"))) %>%
  mutate(Abundance = round(100 * Abundance, 1))}) %>%
  bind_rows()
```


Compute the abundance of shared OTUs between water and intestinal samples.

```{r}
shared_water <- map(c("water.M", "water.V", "water.MM", "water.VM", "water.MMV", "water.VMV"), function(x) {
  prune_taxa(names(which(prvl[[x]] > 0)), ps_tss_1) %>% sample_sums()
}
)
names(shared_water) <- c("M", "V", "MM", "VM", "MMV", "VMV")
# names(prvl)

shared_water <- map(seq_along(shared_water), function(x){
  data.frame(Abundance = shared_water[[x]]) %>%
    rownames_to_column("sample_name") %>%
    inner_join(rownames_to_column(mtd, "sample_name"), by = "sample_name") %>%
    filter(Regime == names(shared_water)[x] & !sample %in% c("feed", "water")) %>%
    #mutate(Segment = ifelse(Segment == "PI", "PIM", "DIM"),
    #Segment = factor(Segment, levels = c("PIM", "DIM"))) %>%
    mutate(Abundance = round(100 * Abundance, 1))}) %>%
  bind_rows()
```

Plotting
Abundance of shared OTUs between feed and intestinal samples.

```{r}
bp_shared_feed <- ggplot(shared_feed, aes(x = Regime, y = Abundance)) +
  geom_boxplot(fill = "grey50", width = 0.5) +
  geom_point() +
  #facet_nested(~ Diet + Segment, scales = "free_x", nest_line = TRUE) +
  labs(x = "", y = "Relative abundance of shared ASVs (%)", size = 10) +
  scale_x_discrete(limit=c("M", "V", "MM", "VM", "MMV", "VMV")) +
  scale_y_continuous(
    limits = c(0, 100), breaks = 0:10*10, expand = expansion(c(0, 0))
    ) + 
  theme_bw() +
  theme(axis.text.x = element_text (size = 9),
        strip.background = element_blank(),
        legend.position = "none")

```

Abundance of shared OTUs between water and intestinal samples.

```{r}
bp_shared_water <- shared_water %>%
  ggplot(aes(x = Regime, y = Abundance)) +
    geom_boxplot(fill = "grey50", width = 0.5) +
    geom_point() +
    #facet_nested(~ Diet + Segment, scales = "free_x", nest_line = TRUE) +
    labs(x = "", y = "Relative abundance of shared ASVs (%)", size = 10) +
    scale_y_continuous(
      limits = c(0, 100), breaks = 0:10*10, expand = expansion(c(0, 0))
      ) + 
    scale_x_discrete(limit=c("M", "V", "MM", "VM", "MMV", "VMV")) +
    theme_bw() +
    theme(axis.text.x = element_text (size = 9),
          strip.background = element_blank(),
          legend.position = "none") 

```

Assemble plots
```{r}
bp_shared_feed + bp_shared_water
```

Figure 7

```{r}
library(patchwork)
fig7a <- ovrl_bar_feed + bp_shared_feed + 
  plot_layout(guides = "collect") +
  plot_annotation(tag_levels = list(c("A", ""))) &
  theme(
    legend.position = "top",
    legend.margin = margin(0, 0, 0, 0),
    legend.box.margin = margin(10, 10, 10, 10))
fig7b <- ovrl_bar_water + bp_shared_water +
  plot_layout(guides = "collect") +
  plot_annotation(tag_levels = list(c("B", ""))) &
  theme(
    legend.position = "top",
    legend.margin = margin(0, 0, 0, 0),
    legend.box.margin = margin(10, 10, 10, 10))
wrap_elements(full = fig7a) | wrap_elements(full = fig7b) 

# export plot
ggsave(("figures/sharedASVs.RA.tiff"), width = 12, height = 5,
       units = "in", dpi = 300, compression = "lzw")

```
